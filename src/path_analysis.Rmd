```{r Dependencies}
if (!requireNamespace("lavaan")) {
    install.packages("lavaan")
}
if (!requireNamespace("arrow")) {
    install.packages("arrow")
}

library(lavaan)
library(arrow)
```

```{r Load data}
all_data <- read_feather("/tmp/panel_data.feather")
head(all_data)

options(max.print = 2500)
```

```{r}
sem_model <- "
# Regressions (structural part)
mhi5_13 ~ alpha_mhi5_13*1 + rho1*mhi5_12 + rho2*mhi5_11 + rho3*mhi5_10 + rho4*mhi5_9 + rho5*mhi5_8 + beta0_cs104*cs104_13 + beta1_cs104*cs104_12 + omega0_bmi.normal.weight*bmi_13.normal.weight + omega0_bmi.overweight*bmi_13.overweight + omega0_bmi.obese*bmi_13.obese + omega0_ch178*ch178_13 + delta_leeftijd.18.24*leeftijd_first.18.24 + delta_leeftijd.25.39*leeftijd_first.25.39 + delta_leeftijd.40.66*leeftijd_first.40.66 + delta_leeftijd.over.67*leeftijd_first.over.67 + delta_nettohh_f.under.15k*nettohh_f_first.under.15k + delta_nettohh_f.over.50k*nettohh_f_first.over.50k + delta_herkomstgroep.first.w*herkomstgroep_first.first.w + delta_herkomstgroep.first.nonw*herkomstgroep_first.first.nonw + delta_herkomstgroep.second.w*herkomstgroep_first.second.w + delta_herkomstgroep.second.nonw*herkomstgroep_first.second.nonw + delta_geslacht.male*geslacht_first.male + delta_burgstat.married*burgstat_first.married + delta_burgstat.never.been.married*burgstat_first.never.been.married + delta_burgstat.separated*burgstat_first.separated + delta_burgstat.widow.or.widower*burgstat_first.widow.or.widower + delta_oplcat.hbo*oplcat_first.hbo + delta_oplcat.mbo*oplcat_first.mbo + delta_oplcat.primary.school*oplcat_first.primary.school + delta_oplcat.vmbo*oplcat_first.vmbo + delta_oplcat.wo*oplcat_first.wo + delta_employment.homemaker*employment_first.homemaker + delta_employment.retired*employment_first.retired + delta_employment.student*employment_first.student + delta_employment.unable.to.work*employment_first.unable.to.work + delta_employment.unemployed*employment_first.unemployed
mhi5_20 ~ alpha_mhi5_20*1 + rho1*mhi5_19 + rho2*mhi5_18 + rho3*mhi5_17 + rho4*mhi5_16 + rho5*mhi5_15 + beta0_cs104*cs104_20 + beta1_cs104*cs104_19 + omega0_bmi.normal.weight*bmi_20.normal.weight + omega0_bmi.overweight*bmi_20.overweight + omega0_bmi.obese*bmi_20.obese + omega0_ch178*ch178_20 + delta_leeftijd.18.24*leeftijd_first.18.24 + delta_leeftijd.25.39*leeftijd_first.25.39 + delta_leeftijd.40.66*leeftijd_first.40.66 + delta_leeftijd.over.67*leeftijd_first.over.67 + delta_nettohh_f.under.15k*nettohh_f_first.under.15k + delta_nettohh_f.over.50k*nettohh_f_first.over.50k + delta_herkomstgroep.first.w*herkomstgroep_first.first.w + delta_herkomstgroep.first.nonw*herkomstgroep_first.first.nonw + delta_herkomstgroep.second.w*herkomstgroep_first.second.w + delta_herkomstgroep.second.nonw*herkomstgroep_first.second.nonw + delta_geslacht.male*geslacht_first.male + delta_burgstat.married*burgstat_first.married + delta_burgstat.never.been.married*burgstat_first.never.been.married + delta_burgstat.separated*burgstat_first.separated + delta_burgstat.widow.or.widower*burgstat_first.widow.or.widower + delta_oplcat.hbo*oplcat_first.hbo + delta_oplcat.mbo*oplcat_first.mbo + delta_oplcat.primary.school*oplcat_first.primary.school + delta_oplcat.vmbo*oplcat_first.vmbo + delta_oplcat.wo*oplcat_first.wo + delta_employment.homemaker*employment_first.homemaker + delta_employment.retired*employment_first.retired + delta_employment.student*employment_first.student + delta_employment.unable.to.work*employment_first.unable.to.work + delta_employment.unemployed*employment_first.unemployed
mhi5_21 ~ alpha_mhi5_21*1 + rho1*mhi5_20 + rho2*mhi5_19 + rho3*mhi5_18 + rho4*mhi5_17 + rho5*mhi5_16 + beta0_cs104*cs104_21 + beta1_cs104*cs104_20 + omega0_bmi.normal.weight*bmi_21.normal.weight + omega0_bmi.overweight*bmi_21.overweight + omega0_bmi.obese*bmi_21.obese + omega0_ch178*ch178_21 + delta_leeftijd.18.24*leeftijd_first.18.24 + delta_leeftijd.25.39*leeftijd_first.25.39 + delta_leeftijd.40.66*leeftijd_first.40.66 + delta_leeftijd.over.67*leeftijd_first.over.67 + delta_nettohh_f.under.15k*nettohh_f_first.under.15k + delta_nettohh_f.over.50k*nettohh_f_first.over.50k + delta_herkomstgroep.first.w*herkomstgroep_first.first.w + delta_herkomstgroep.first.nonw*herkomstgroep_first.first.nonw + delta_herkomstgroep.second.w*herkomstgroep_first.second.w + delta_herkomstgroep.second.nonw*herkomstgroep_first.second.nonw + delta_geslacht.male*geslacht_first.male + delta_burgstat.married*burgstat_first.married + delta_burgstat.never.been.married*burgstat_first.never.been.married + delta_burgstat.separated*burgstat_first.separated + delta_burgstat.widow.or.widower*burgstat_first.widow.or.widower + delta_oplcat.hbo*oplcat_first.hbo + delta_oplcat.mbo*oplcat_first.mbo + delta_oplcat.primary.school*oplcat_first.primary.school + delta_oplcat.vmbo*oplcat_first.vmbo + delta_oplcat.wo*oplcat_first.wo + delta_employment.homemaker*employment_first.homemaker + delta_employment.retired*employment_first.retired + delta_employment.student*employment_first.student + delta_employment.unable.to.work*employment_first.unable.to.work + delta_employment.unemployed*employment_first.unemployed
mhi5_22 ~ alpha_mhi5_22*1 + rho1*mhi5_21 + rho2*mhi5_20 + rho3*mhi5_19 + rho4*mhi5_18 + rho5*mhi5_17 + beta0_cs104*cs104_22 + beta1_cs104*cs104_21 + omega0_bmi.normal.weight*bmi_22.normal.weight + omega0_bmi.overweight*bmi_22.overweight + omega0_bmi.obese*bmi_22.obese + omega0_ch178*ch178_22 + delta_leeftijd.18.24*leeftijd_first.18.24 + delta_leeftijd.25.39*leeftijd_first.25.39 + delta_leeftijd.40.66*leeftijd_first.40.66 + delta_leeftijd.over.67*leeftijd_first.over.67 + delta_nettohh_f.under.15k*nettohh_f_first.under.15k + delta_nettohh_f.over.50k*nettohh_f_first.over.50k + delta_herkomstgroep.first.w*herkomstgroep_first.first.w + delta_herkomstgroep.first.nonw*herkomstgroep_first.first.nonw + delta_herkomstgroep.second.w*herkomstgroep_first.second.w + delta_herkomstgroep.second.nonw*herkomstgroep_first.second.nonw + delta_geslacht.male*geslacht_first.male + delta_burgstat.married*burgstat_first.married + delta_burgstat.never.been.married*burgstat_first.never.been.married + delta_burgstat.separated*burgstat_first.separated + delta_burgstat.widow.or.widower*burgstat_first.widow.or.widower + delta_oplcat.hbo*oplcat_first.hbo + delta_oplcat.mbo*oplcat_first.mbo + delta_oplcat.primary.school*oplcat_first.primary.school + delta_oplcat.vmbo*oplcat_first.vmbo + delta_oplcat.wo*oplcat_first.wo + delta_employment.homemaker*employment_first.homemaker + delta_employment.retired*employment_first.retired + delta_employment.student*employment_first.student + delta_employment.unable.to.work*employment_first.unable.to.work + delta_employment.unemployed*employment_first.unemployed
mhi5_23 ~ alpha_mhi5_23*1 + rho1*mhi5_22 + rho2*mhi5_21 + rho3*mhi5_20 + rho4*mhi5_19 + rho5*mhi5_18 + beta0_cs104*cs104_23 + beta1_cs104*cs104_22 + omega0_bmi.normal.weight*bmi_23.normal.weight + omega0_bmi.overweight*bmi_23.overweight + omega0_bmi.obese*bmi_23.obese + omega0_ch178*ch178_23 + delta_leeftijd.18.24*leeftijd_first.18.24 + delta_leeftijd.25.39*leeftijd_first.25.39 + delta_leeftijd.40.66*leeftijd_first.40.66 + delta_leeftijd.over.67*leeftijd_first.over.67 + delta_nettohh_f.under.15k*nettohh_f_first.under.15k + delta_nettohh_f.over.50k*nettohh_f_first.over.50k + delta_herkomstgroep.first.w*herkomstgroep_first.first.w + delta_herkomstgroep.first.nonw*herkomstgroep_first.first.nonw + delta_herkomstgroep.second.w*herkomstgroep_first.second.w + delta_herkomstgroep.second.nonw*herkomstgroep_first.second.nonw + delta_geslacht.male*geslacht_first.male + delta_burgstat.married*burgstat_first.married + delta_burgstat.never.been.married*burgstat_first.never.been.married + delta_burgstat.separated*burgstat_first.separated + delta_burgstat.widow.or.widower*burgstat_first.widow.or.widower + delta_oplcat.hbo*oplcat_first.hbo + delta_oplcat.mbo*oplcat_first.mbo + delta_oplcat.primary.school*oplcat_first.primary.school + delta_oplcat.vmbo*oplcat_first.vmbo + delta_oplcat.wo*oplcat_first.wo + delta_employment.homemaker*employment_first.homemaker + delta_employment.retired*employment_first.retired + delta_employment.student*employment_first.student + delta_employment.unable.to.work*employment_first.unable.to.work + delta_employment.unemployed*employment_first.unemployed

# Additional covariances
cs104_12 ~~ sigma1_cs104_cs104*cs104_13 + sigma7_cs104_cs104*cs104_19 + sigma8_cs104_cs104*cs104_20 + sigma9_cs104_cs104*cs104_21 + sigma10_cs104_cs104*cs104_22 + sigma11_cs104_cs104*cs104_23
cs104_13 ~~ sigma6_cs104_cs104*cs104_19 + sigma7_cs104_cs104*cs104_20 + sigma8_cs104_cs104*cs104_21 + sigma9_cs104_cs104*cs104_22 + sigma10_cs104_cs104*cs104_23
cs104_19 ~~ sigma1_cs104_cs104*cs104_20 + sigma2_cs104_cs104*cs104_21 + sigma3_cs104_cs104*cs104_22 + sigma4_cs104_cs104*cs104_23
cs104_20 ~~ sigma1_cs104_cs104*cs104_21 + sigma2_cs104_cs104*cs104_22 + sigma3_cs104_cs104*cs104_23
cs104_21 ~~ sigma1_cs104_cs104*cs104_22 + sigma2_cs104_cs104*cs104_23
cs104_22 ~~ sigma1_cs104_cs104*cs104_23
mhi5_13 ~~ gamma7_y_x*cs104_20 + gamma6_y_x*cs104_19 + gamma8_y_x*cs104_21 + gamma9_y_x*cs104_22 + gamma10_y_x*cs104_23
mhi5_20 ~~ gamma1_y_x*cs104_21 + gamma2_y_x*cs104_22 + gamma3_y_x*cs104_23
mhi5_21 ~~ gamma1_y_x*cs104_22 + gamma2_y_x*cs104_23
mhi5_22 ~~ gamma1_y_x*cs104_23

"
```

```{r}
fit <- sem(sem_model, data = all_data)

summary(fit, fit.measures = TRUE)
```

```{r}
# Potential model improvements
mi <- modificationindices(fit)

head(mi[order(-mi$mi), , ], 10)
```
